<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Clientes — EcoBox Admin</title>

  <!-- libs -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/lucide@latest"></script>

  <style>
    :root{
      --sidebar-bg: #072617;
      --accent: #32c77b;
      --muted: #6b7a76;
      --card-bg: #ffffff;
      --surface: #f7faf7;
    }

    *{box-sizing:border-box}
    body{
      font-family: 'Poppins', system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial;
      background: linear-gradient(180deg, #f4f7f5 0%, #eef4ef 100%);
      color:#0b2b20;
      margin:0; padding:0;
    }

    /* Sidebar (idêntico ao original) */
    .sidebar {
      width: 260px;
      background: #0d2b1d;
      min-height: 100vh;
      padding: 25px 18px;
      color: #fff;
      display: flex;
      flex-direction: column;
      position: fixed;
      top: 0;
      left: 0;
      z-index: 1000;
    }

    .sidebar h3 {
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .sidebar hr {
      border-color: rgba(255, 255, 255, 0.15);
      margin: 20px 0;
    }

    .sidebar a {
      color: #e1e1e1;
      text-decoration: none;
      display: flex;
      align-items: center;
      font-size: 17px;
      padding: 12px 10px;
      border-radius: 10px;
      transition: 0.2s ease-in-out;
      font-weight: 500;
    }

    .sidebar a svg {
      margin-right: 12px;
    }

    .sidebar a:hover {
      background: rgba(255, 255, 255, 0.12);
      color: #fff;
      transform: translateX(4px);
    }

    .sidebar a.active {
      background: #1a4e37;
      color: #fff;
      border-left: 4px solid #41c77a;
      padding-left: 12px;
    }

    .sidebar-bottom {
      margin-top: auto;
    }

    .brand{display:flex; align-items:center; gap:12px}
    .brand .logo{
      width:44px; height:44px; border-radius:10px; background: linear-gradient(135deg,var(--accent), #1ea56a);
      display:flex; align-items:center; justify-content:center; font-weight:700; color:#042418; font-size:18px;
    }

    .nav-link-custom{color: #dbeee2; padding:10px 12px; border-radius:10px; display:flex; align-items:center; gap:10px; text-decoration:none}
    .nav-link-custom:hover{background: rgba(255,255,255,0.06); transform:translateX(6px); color:#fff}
    .nav-link-custom.active{background: rgba(255,255,255,0.06); border-left:4px solid var(--accent); color:#fff}

    /* Layout / Conteúdo */
    .main{flex:1; padding:28px;}
    .layout{display:flex}

    /* Ajustei padding para alinhar tabela à esquerda (mesma coluna do título) */
    .content-wrap{
      margin-left: 260px; /* empurra pra direita por causa do sidebar fixo */
      padding: 28px 32px; /* left padding = 28, right = 32 => mais equilibrado */
      min-height: 100vh;
    }

    .title-page{font-size:26px; font-weight:700; color:#072617}

    .card-custom{
      border-radius:12px;
      border:0;
      box-shadow: 0 6px 20px rgba(8,32,18,0.06);
      background: var(--card-bg);
      padding: 16px;        /* reduzido para evitar deslocamento visual */
      margin: 0;            /* garante que card comece na mesma coluna do título */
      width: 100%;          /* ocupa toda a largura interna do content-wrap */
    }

    /* Garantir que table ocupe toda área do card sem deslocamentos estranhos */
    .table-responsive{
      width: 100%;
      margin: 0;
    }

    .table { width: 100%; }         /* força a tabela a alinhar à borda esquerda do card */
    .table thead th{border-bottom:0}
    .table tbody tr:hover{background: linear-gradient(90deg,#f3fff7, #fbfffb)}

    /* Força alinhamento das células à esquerda (evita sensação de deslocamento) */
    .table td, .table th { text-align: left; vertical-align: middle; }

    .status-pill{display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border-radius:999px; font-weight:600; text-transform:capitalize}
    .status-pendente{background:#fff3cd; color:#7a5a00}
    .status-processando{background:#e6f7ff; color:#055160}
    .status-enviado{background:#e6f0ff; color:#163a8a}
    .status-entregue{background:#e6ffef; color:#0a6f3a}
    .status-cancelado{background:#ffecec; color:#8a0b0b}

    /* Controls */
    .controls{display:flex; gap:12px; align-items:center}
    .search-input{min-width:260px}

    /* Clientes page specific */
    .page-title{
      font-size:32px;
      font-weight:800;
    }

    .card-pro{
      background:#fff;
      border-radius:16px;
      padding:20px;
      box-shadow:0 10px 30px rgba(0,0,0,.06);
      margin-bottom:18px;
    }

    .table th{
      background:#edf7ef;
      padding:14px;
    }
    .table td{
      padding:12px 10px;
    }

    .cliente-thumb{
      width:60px;
      height:60px;
      border-radius:12px;
      object-fit:cover;
      box-shadow:0 4px 10px rgba(0,0,0,.1);
    }

    /* responsive */
    @media (max-width: 900px){
      .content-wrap{margin-left:0; padding:16px}
      .sidebar{position:relative; width:100%; flex-direction:row; padding:12px; align-items:center}
      .sidebar nav{display:flex; gap:8px}
    }
  </style>
</head>

<body>
  <div class="d-flex layout">
    <!-- Sidebar (idêntico ao que você enviou) -->
    <aside class="sidebar" id="sidebar">
      <div class="brand">
        <div class="logo">EB</div>
        <div>
          <div class="fw-bold text-uppercase">EcoBox Admin</div>
          <div class="muted">Painel de Controle</div>
        </div>
      </div>

      <hr>

      <nav class="d-flex flex-column mt-2">
        <a class="nav-link-custom" href="/admin/estatisticas"><i data-lucide="bar-chart-3"></i> Estatísticas</a>
        <a class="nav-link-custom" href="/admin/produtos"><i data-lucide="package"></i> Produtos</a>
        <a class="nav-link-custom" href="/admin/pedidos"><i data-lucide="receipt"></i> Pedidos</a>
        <a class="nav-link-custom active" href="/admin/clientes"><i data-lucide="users"></i> Clientes</a>
      </nav>

      <hr>

      <div class="mt-auto">
        <a href="/visitante" class="nav-link-custom"><i data-lucide="log-out"></i> Sair</a>
      </div>
    </aside>

    <!-- Conteúdo -->
    <main class="main w-100">
      <div class="content-wrap">
        <div class="d-flex justify-content-between align-items-center mb-4">
          <div>
            <h1 class="title-page mb-1">Clientes</h1>
            <small class="text-muted">Lista de clientes e histórico</small>
          </div>

          <div class="d-flex gap-3 align-items-center">
            <button class="btn btn-outline-secondary d-md-none" id="toggleSidebar"><i data-lucide="menu"></i></button>

            <div class="controls">
              <input id="search" class="form-control search-input" placeholder="Pesquisar cliente..." />

              <select id="filterStatus" class="form-select" style="min-width:160px">
                <option value="">Todos status</option>
                <option value="ativos">Ativos</option>
                <option value="inativos">Inativos</option>
              </select>
            </div>
          </div>
        </div>

        <div class="card-custom">
          <div class="table-responsive">
            <table class="table table-hover align-middle mb-0" id="clientesTable">
              <thead class="table-light">
                <tr>
                  <th>Cliente</th>
                  <th>E-mail</th>
                  <th>Status</th>
                  <th>Pedidos</th>
                  <th>Cadastrado</th>
                  <th class="text-end">Ações</th>
                </tr>
              </thead>

              <tbody>
                {% for c in clientes %}
                <tr data-id="{{ c.id }}">
                  <td class="d-flex align-items-center gap-3">
                    {# normaliza fonte da imagem: aceita url absoluta, caminhos começando com "/" ou "static/..." ou vazio #}
                    {% set foto_raw = c.foto_usuario or 'static/img/padrao_foto.png' %}
                    
                    {% if foto_raw.startswith('http') %}
                      <img src="{{ foto_raw }}" class="cliente-thumb" alt="Foto {{ c.nome }}">
                    {% elif foto_raw.startswith('/') %}
                      {# caminho absoluto já (ex: /static/...) #}
                      <img src="{{ foto_raw }}" class="cliente-thumb" alt="Foto {{ c.nome }}">
                    {% else %}
                      {# assume caminho relativo que começa com "static/..." ou apenas "img/..." #}
                      {% if foto_raw.startswith('static/') %}
                        {% set foto_static = foto_raw.replace('static/', '') %}
                      {% else %}
                        {% set foto_static = foto_raw %}
                      {% endif %}
                      <img src="{{ url_for('static', filename=foto_static) }}" class="cliente-thumb" alt="Foto {{ c.nome }}">
                    {% endif %}                    
                    <div>
                      <strong>{{ c.nome }}</strong><br>
                      <small class="text-muted">ID #{{ c.id }}</small>
                    </div>
                  </td>

                  <td>{{ c.email }}</td>

                  <td>
                    <span class="status-pill status-entregue">{{ c.status or "ativo" }}</span>
                  </td>

                  <td>{{ c.total_pedidos or 0 }}</td>
                  <td>{{ c.data_cadastro }}</td>

                  <td class="text-end">
                    <a href="/admin/clientes/{{ c.id }}" class="btn btn-sm btn-outline-primary me-1">Ver</a>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>

          <!-- footer simples -->
          <div class="d-flex justify-content-between align-items-center mt-3">
            <small class="text-muted">Mostrando <span id="shownCount">0</span> clientes</small>
            <nav>
              <ul class="pagination mb-0">
                <li class="page-item disabled"><a class="page-link" href="#">«</a></li>
                <li class="page-item active"><a class="page-link" href="#">1</a></li>
                <li class="page-item"><a class="page-link" href="#">2</a></li>
                <li class="page-item"><a class="page-link" href="#">3</a></li>
                <li class="page-item"><a class="page-link" href="#">»</a></li>
              </ul>
            </nav>
          </div>
        </div>

      </div>
    </main>
  </div>

  <!-- Modal quick view (opcional) -->
  <div class="modal fade" id="quickViewModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Cliente <span id="modalClienteId"></span></h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
        </div>
        <div class="modal-body" id="modalBody">Carregando...</div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- scripts -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    lucide.createIcons();

    // Toggle sidebar on small screens
    const toggleBtn = document.getElementById('toggleSidebar');
    if (toggleBtn) {
      toggleBtn.addEventListener('click', function(){
        document.getElementById('sidebar').classList.toggle('open');
      });
    }

    // Basic client-side search + filter for clientesTable
    const searchInput = document.getElementById('search');
    const filterSelect = document.getElementById('filterStatus');
    const table = document.getElementById('clientesTable');
    const rows = table ? Array.from(table.querySelectorAll('tbody tr')) : [];
    const shownCountEl = document.getElementById('shownCount');

    function applyFilters(){
      const q = (searchInput?.value || '').toLowerCase();
      const status = filterSelect?.value || '';
      let shown = 0;

      rows.forEach(r => {
        const txt = r.innerText.toLowerCase();
        const rowStatus = r.querySelector('.status-pill')?.innerText?.trim().toLowerCase() || '';

        const matchesQuery = q === '' || txt.indexOf(q) !== -1;
        const matchesStatus = status === '' || rowStatus === status;

        if(matchesQuery && matchesStatus){
          r.style.display = '';
          shown++;
        } else {
          r.style.display = 'none';
        }
      });

      if(shownCountEl) shownCountEl.textContent = shown;
    }

    searchInput?.addEventListener('input', applyFilters);
    filterSelect?.addEventListener('change', applyFilters);
    applyFilters();

    // Delegação de evento para Quick View (se usar botões com classe quickview-btn)
    document.addEventListener('click', function(e){
      const btn = e.target.closest('.quickview-btn');
      if (!btn) return;
      const id = btn.dataset.clienteId;
      if (id) openQuickView(id);
    });

    function openQuickView(id){
      const modal = new bootstrap.Modal(document.getElementById('quickViewModal'));
      document.getElementById('modalClienteId').textContent = '#' + id;
      document.getElementById('modalBody').innerHTML = '<p>Carregando detalhes do cliente ' + id + '...</p>';
      // fetch(`/admin/clientes/${id}/quick`).then(...)
      modal.show();
    }

    window.openQuickView = openQuickView;
  </script>
</body>
</html>
