{# templates/settings/privacidade.html #}
{% extends "settings/base.html" %}
{% block content %}

<style>
  .settings-section { padding: 22px; }
  .privacy-card {
    max-width: 760px;           /* menor que antes */
    margin: 14px auto;
    background: linear-gradient(180deg, rgba(20,46,28,0.45), rgba(10,30,20,0.25));
    border-radius: 14px;
    padding: 16px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.35);
    display: grid;
    grid-template-columns: 1fr 300px; /* coluna direita menor */
    gap: 14px;
  }

  @media (max-width: 980px) {
    .privacy-card { grid-template-columns: 1fr; padding: 12px; max-width: 92%; }
  }

  .privacy-left { padding-right: 8px; font-size: 14px; }
  .privacy-right {
    background: rgba(10,30,20,0.12);
    border-radius: 10px;
    padding: 12px;
    font-size: 13px;
    color: #d6ffb2;
    min-height: 110px;
  }

  h2.small-title { font-size: 20px; margin: 0 0 6px 0; color: var(--green-light); }
  p.muted { color: #cfeccf; font-size: 13px; margin: 6px 0 12px; line-height:1.35; }

  .action-block { margin: 10px 0 14px; }
  .action-block .title { font-weight:700; margin-bottom:6px; color:#fff; font-size:15px; }
  .action-block .desc { font-size:13px; color:#cfeccf; margin-bottom:8px; }

  .btn { background:var(--green-mid); color:#012; padding:8px 12px; border:none; border-radius:8px; font-weight:700; cursor:pointer; font-size:13px; }
  .btn.small { padding:6px 10px; font-size:13px; }
  .btn.ghost { background:transparent; color:#cfeccf; border:1px solid rgba(255,255,255,0.06); }
  .btn.danger { background:#e35b5b; color:#fff; }

  .quick-pref { margin-top: 10px; }
  .quick-row { display:flex; align-items:center; justify-content:space-between; gap:12px; padding:10px 0; border-top:1px dashed rgba(255,255,255,0.02); font-size:13px; }
  .quick-row:first-child { border-top: none; }
  .quick-label { font-weight:600; color:#e9ffea; font-size:14px; }
  .checkbox-inline { display:flex; align-items:center; gap:8px; color:#cfeccf; font-size:13px; }

  .logs { font-size:13px; color:#cfeccf; opacity:0.95; }

  .toast-local { position:fixed; right:30px; bottom:30px; background:#28a745; color:#fff; padding:10px 14px; border-radius:8px; display:none; z-index:99999; box-shadow:0 8px 20px rgba(0,0,0,0.2); font-weight:700; }
</style>

<div class="settings-section" id="privacidade">
  <div class="privacy-card" role="region" aria-label="Configurações de privacidade">

    <div class="privacy-left">
      <h2 class="small-title">Privacidade e dados</h2>
      <p class="muted">Gerencie como seus dados são usados no EcoBox. Solicite cópia, exclua a conta ou ajuste preferências rápidas.</p>

      <div class="action-block" aria-labelledby="solicitar-copia">
        <div class="title" id="solicitar-copia">Solicitar cópia dos meus dados</div>
        <div class="desc">Receba um arquivo com os dados pessoais e históricos registrados nesta conta.</div>
        <button id="solicitarCopiaBtn" class="btn small">Solicitar</button>
      </div>

      <div class="action-block" aria-labelledby="excluir-conta">
        <div class="title" id="excluir-conta">Excluir minha conta</div>
        <div class="desc">Remover sua conta e dados pessoais do sistema (irreversível).</div>
        <button id="excluirContaBtn" class="btn small danger">Excluir</button>
      </div>

      <div style="height:6px"></div>

      <div class="title" style="margin-top:6px; color:var(--green-light); font-size:15px">Preferências rápidas</div>
      <div class="quick-pref">
        <div class="quick-row">
          <div>
            <div class="quick-label">Perfil público</div>
            <div class="desc" style="margin:4px 0 0;">Se ativado, seu nome/foto podem aparecer em avaliações.</div>
          </div>
          <label class="checkbox-inline">
            <input id="perfil_publico" type="checkbox"> Ativar
          </label>
        </div>

        <div class="quick-row">
          <div>
            <div class="quick-label">Aceitar cookies de marketing</div>
            <div class="desc" style="margin:4px 0 0;">Controla se você recebe anúncios personalizados.</div>
          </div>
          <label class="checkbox-inline">
            <input id="cookies_marketing" type="checkbox"> Ativar
          </label>
        </div>
      </div>

      <div style="margin-top:12px; display:flex; gap:10px;">
        <button id="salvarPrivBtn" class="btn small">Salvar preferências</button>
        <button id="reverterPrivBtn" class="btn small ghost">Reverter</button>
      </div>
    </div>

    <aside class="privacy-right" aria-live="polite">
      <div style="font-weight:700; color:var(--green-light); margin-bottom:8px;">O que acontece quando...</div>

      <div style="margin-bottom:10px;">
        <div style="font-weight:700; color:#fff;">Solicitar cópia</div>
        <div class="logs">Seu pedido é registrado e um arquivo será gerado; você será notificado por e-mail quando disponível.</div>
      </div>

      <div style="margin-bottom:10px;">
        <div style="font-weight:700; color:#fff;">Excluir conta</div>
        <div class="logs">Dados pessoais e históricos são removidos do sistema. Alguns registros podem ser mantidos anonimizados por razões legais.</div>
      </div>

      <div style="margin-top:6px;">
        <div style="font-weight:700; color:var(--green-light); margin-bottom:6px;">Logs rápidos</div>
        <div class="logs" id="logsQuick">Nenhuma ação recente registrada.</div>
      </div>
    </aside>

  </div>
</div>

<div id="toast" class="toast-local" role="status" aria-live="polite"></div>

<script>
  // objeto user (se disponível no contexto)
  const userObj = JSON.parse(`{{ user|tojson|safe if user is defined else '{}' }}`);

  const safe = v => (v === null || typeof v === 'undefined') ? false : v;
  const initial = {
    perfil_publico: safe(userObj.perfil_publico) ? true : false,
    cookies_marketing: safe(userObj.cookies_marketing) ? true : false
  };

  document.addEventListener('DOMContentLoaded', () => {
    document.getElementById('perfil_publico').checked = initial.perfil_publico;
    document.getElementById('cookies_marketing').checked = initial.cookies_marketing;

    document.getElementById('solicitarCopiaBtn').addEventListener('click', solicitarCopia);
    document.getElementById('excluirContaBtn').addEventListener('click', excluirContaConfirm);
    document.getElementById('salvarPrivBtn').addEventListener('click', salvarPreferencias);
    document.getElementById('reverterPrivBtn').addEventListener('click', reverterPreferencias);
  });

  function showToast(msg, error=false, time=2600) {
    const t = document.getElementById('toast');
    t.textContent = msg;
    t.style.background = error ? '#dc3545' : '#28a745';
    t.style.display = 'block';
    clearTimeout(t._t);
    t._t = setTimeout(()=> t.style.display = 'none', time);
  }

  async function solicitarCopia() {
    const url = "{{ url_for('solicitar_copia_dados') }}";
    try {
      const res = await fetch(url, { method: 'POST', credentials: 'same-origin' });
      const data = await res.json().catch(()=>({}));
      if (res.ok && data.ok) {
        showToast(data.message || "Pedido registrado.");
        document.getElementById('logsQuick').textContent = "Pedido de cópia registrado há pouco.";
      } else {
        showToast(data.message || data.error || "Erro ao solicitar.", true);
      }
    } catch (err) {
      console.error(err);
      showToast("Erro de rede ao solicitar.", true);
    }
  }

  function excluirContaConfirm() {
    if (!confirm("Tem certeza? Excluir sua conta é irreversível.")) return;
    showToast("Função de exclusão não implementada no servidor.", true);
  }

  async function salvarPreferencias() {
    const payload = {
      perfil_publico: document.getElementById('perfil_publico').checked ? 1 : 0,
      cookies_marketing: document.getElementById('cookies_marketing').checked ? 1 : 0
    };

    const maybeUrl = "{{ url_for('atualizar_notificacoes') }}" || null;

    try {
      const res = await fetch(maybeUrl, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        credentials: 'same-origin',
        body: JSON.stringify(payload)
      });
      const data = await res.json().catch(()=>({}));
      if (res.ok && data.ok) {
        showToast("Preferências salvas.");
        document.getElementById('logsQuick').textContent = "Preferências salvas há pouco.";
      } else {
        showToast(data.message || data.error || "Erro ao salvar.", true);
      }
    } catch (err) {
      console.error(err);
      showToast("Erro de rede ao salvar.", true);
    }
  }

  function reverterPreferencias() {
    document.getElementById('perfil_publico').checked = initial.perfil_publico;
    document.getElementById('cookies_marketing').checked = initial.cookies_marketing;
    showToast("Revertido.");
  }
</script>

{% endblock %}
